<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | HQ æˆ°è¡“æŒ‡æ®ä¸­å¿ƒ V6.5</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #000; color: #00f2ff; font-family: "Microsoft JhengHei", sans-serif; padding: 15px; margin: 0; }
        .header { border-bottom: 2px solid #00f2ff; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .section { background: #111; padding: 15px; border-radius: 5px; border: 1px solid #333; margin-bottom: 20px; position: relative; }
        h2 { color: #4da1ff; font-size: 16px; margin-top: 0; border-left: 5px solid #00f2ff; padding-left: 10px; }
        
        /* çµ±è¨ˆçœ‹æ¿ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #1a1a1a; padding: 10px; text-align: center; border-radius: 4px; border: 1px solid #444; }
        .stat-val { font-size: 18px; font-weight: bold; color: #ffca28; }
        .stat-label { font-size: 10px; color: #888; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        input, select { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 10px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn { background: #00f2ff; color: #000; border: none; padding: 12px; font-weight: bold; width: 100%; border-radius: 3px; cursor: pointer; }
        .btn-vip { background: #ffca28; color: #000; }
        .btn-red { background: #ff4d4f; color: #fff; }
        
        .scroll-box { max-height: 250px; overflow-y: auto; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #4da1ff; border-bottom: 1px solid #333; padding: 8px; font-size: 12px; position: sticky; top: 0; background: #111; }
        td { padding: 10px 8px; border-bottom: 1px solid #222; color: #ccc; }
        
        /* ç‰¹æ®Šæ¨£å¼ */
        .vip-row { background: rgba(255, 202, 40, 0.1); border-left: 4px solid #ffca28; }
        .alert-row { background: rgba(255, 77, 79, 0.15); border-left: 4px solid #ff4d4f; }
        .k9-warn { color: #ffca28; font-weight: bold; }
        button.del-btn { background: #333; color: #ff4d4f; border: 1px solid #444; padding: 3px 8px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 18px;">M-SECURITY HQ</h1>
            <div id="statusInfo" style="color: #888; font-size: 10px;">V6.5 | TACTICAL REINFORCED</div>
        </div>
        <div id="clock" style="font-family: monospace; font-size: 12px;"></div>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countLogs">0</div><div class="stat-label">ä»Šæ—¥æŸ¥è©¢</div></div>
        <div class="stat-card"><div class="stat-val" id="countVip">0</div><div class="stat-label">VIP é•·å®˜</div></div>
        <div class="stat-card"><div class="stat-val" id="countK9">8</div><div class="stat-label">K9 ç¸½é‡</div></div>
    </div>

    <div class="section" style="border-color: #ffca28;">
        <h2 style="color: #ffca28; border-left-color: #ffca28;">ğŸ” å…¨åŸŸæŸ¥è©¢è»Œè·¡ (å« VIP æ””æˆªç›£æ§)</h2>
        <div class="scroll-box">
            <table>
                <thead><tr><th width="20%">æ“ä½œå“¡</th><th width="45%">å°è±¡/å…§å®¹</th><th width="35%">æ™‚é–“</th></tr></thead>
                <tbody id="searchLogs"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ• K9 è‡¨åºŠç‹€æ…‹èˆ‡é€¾æ™‚æé†’</h2>
        <div class="grid">
            <select id="k9Name">
                <option value="å¸ƒä¸">å¼µå¸ƒä¸</option><option value="å°ç™½">è”¡å°ç™½</option><option value="å°èŠ±">è”¡å°èŠ±</option>
                <option value="ä¾†é †">ä¾†é †</option><option value="ç“œç“œ">å“ˆèœœç“œ</option><option value="è²´è²´">è”¡é ­è²´</option>
                <option value="è”¡å“º">è”¡å“º</option><option value="æœ‰éŒ¢">æœ‰éŒ¢</option>
            </select>
            <input type="text" id="k9Note" placeholder="é†«ç™‚/ç‹€æ³ç´€éŒ„">
        </div>
        <button class="btn" onclick="upK9()">æ›´æ–° K9 ç‹€æ…‹</button>
        <div id="k9Dashboard" style="margin-top: 10px; font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"></div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ äººå“¡ç®¡ç†ä¸­å¿ƒ (å“¡å·¥ / è‘£ç›£äº‹)</h2>
        <div class="grid">
            <input type="text" id="eID" placeholder="å·¥è™Ÿ (VIP å¯å¡«è»Šç‰Œ)">
            <input type="text" id="eName" placeholder="å§“å">
        </div>
        <div class="grid">
            <input type="text" id="eDept" placeholder="å–®ä½ / è·ç¨± / é»‘å–®åŸå› ">
            <input type="text" id="ePlate" placeholder="è»Šç‰Œ">
        </div>
        <div class="grid">
            <button class="btn" onclick="upPerson('employee_list')">åŒæ­¥ä¸€èˆ¬å“¡å·¥</button>
            <button class="btn btn-vip" onclick="upPerson('vip_list')">éƒ¨ç½² VIP è‘£ç›£äº‹</button>
        </div>
        <button class="btn btn-red" style="margin-top:8px;" onclick="upBlack()">åˆ—å…¥ç®¡åˆ¶é»‘åå–®</button>
        
        <div class="scroll-box" style="margin-top:15px; border-top:1px solid #333;">
            <table id="masterListTable">
                <thead><tr><th>é¡åˆ¥</th><th>å°è±¡</th><th>è©³æƒ…</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="masterList"></tbody>
            </table>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // æ™‚é˜
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

    // --- åŠŸèƒ½ 1: æ•¸æ“šçµ±è¨ˆ ---
    function updateStats() {
        db.ref('search_logs').once('value', s => {
            const today = new Date().toLocaleDateString();
            const logs = s.val() ? Object.values(s.val()).filter(l => l.time.includes(today)).length : 0;
            document.getElementById('countLogs').innerText = logs;
        });
        db.ref('vip_list').on('value', s => {
            document.getElementById('countVip').innerText = s.val() ? Object.keys(s.val()).length : 0;
        });
    }

    // --- åŠŸèƒ½ 2: æ—¥èªŒç›£æ§ (å« VIP èˆ‡ é»‘åå–®è­˜åˆ¥) ---
    let blacklistNames = [];
    db.ref('blacklist_data').on('value', s => {
        blacklistNames = s.val() ? Object.values(s.val()).map(b => b.name) : [];
    });

    db.ref('search_logs').limitToLast(15).on('value', s => {
        const l = s.val(), b = document.getElementById('searchLogs'); b.innerHTML = '';
        if(l) {
            Object.values(l).reverse().forEach(x => {
                const isBlack = blacklistNames.some(name => x.query.includes(name));
                const isVip = x.query.includes("VIPæŸ¥è©¢");
                let rowClass = isBlack ? 'class="alert-row"' : (isVip ? 'class="vip-row"' : '');
                let icon = isBlack ? ' ğŸ›‘' : (isVip ? ' ğŸ’' : '');
                
                b.innerHTML += `<tr ${rowClass}><td>${x.user}</td><td>${x.query}${icon}</td><td>${x.time}</td></tr>`;
            });
        }
        updateStats();
    });

    // --- åŠŸèƒ½ 3: K9 ç‹€æ…‹ç›£æ§ ---
    const K9_LIST = [{id:'å¸ƒä¸',n:'å¼µå¸ƒä¸'},{id:'å°ç™½',n:'è”¡å°ç™½'},{id:'å°èŠ±',n:'è”¡å°èŠ±'},{id:'ä¾†é †',n:'ä¾†é †'},{id:'ç“œç“œ',n:'å“ˆèœœç“œ'},{id:'è²´è²´',n:'è”¡é ­è²´'},{id:'è”¡å“º',n:'è”¡å“º'},{id:'æœ‰éŒ¢',n:'æœ‰éŒ¢'}];
    function syncK9Health() {
        db.ref('k9Logs').on('value', s => {
            const data = s.val(), board = document.getElementById('k9Dashboard');
            board.innerHTML = '';
            K9_LIST.forEach(k => {
                const logs = data && data[k.id] ? Object.values(data[k.id]).sort((a,b)=>b.timestamp-a.timestamp) : [];
                const lastLog = logs[0];
                let timeDiffStr = "å°šç„¡ç´€éŒ„", warnStyle = "";
                if(lastLog) {
                    const diffHours = (Date.now() - lastLog.timestamp) / (1000 * 60 * 60);
                    timeDiffStr = diffHours < 1 ? "å‰›å‰›æ›´æ–°" : Math.floor(diffHours) + " å°æ™‚å‰";
                    if(diffHours > 24) warnStyle = "class='k9-warn'"; 
                }
                board.innerHTML += `<div style="background:#222; padding:8px; border-radius:3px;"><b>${k.n}</b><br><small ${warnStyle}>â³ ${timeDiffStr}</small></div>`;
            });
        });
    }

    function upK9() {
        const dog = document.getElementById('k9Name').value, note = document.getElementById('k9Note').value;
        if(!note) return alert("ç´€éŒ„ä¸å¯ç©ºç™½");
        db.ref('k9Logs/' + dog).push({ note, timestamp: Date.now(), time: new Date().toLocaleString() });
        logAction("HQ-ADMIN", `K9æ›´æ–°: ${dog}`);
        document.getElementById('k9Note').value = '';
    }

    // --- åŠŸèƒ½ 4: äººå“¡ç®¡ç† (é›™è»Œåˆ¶) ---
    function upPerson(path) {
        const id = document.getElementById('eID').value.trim();
        const name = document.getElementById('eName').value.trim();
        const plate = document.getElementById('ePlate').value.trim().toUpperCase();
        if(!name || (!id && !plate)) return alert("å§“åèˆ‡è­˜åˆ¥ç¢¼(å·¥è™Ÿ/è»Šç‰Œ)å¿…å¡«");

        const data = { id: id || plate, name, dept: document.getElementById('eDept').value, plate };
        db.ref(path + '/' + (id || plate)).set(data);
        if(plate && path === 'employee_list') db.ref(path + '/' + plate).set(data); // å“¡å·¥é¡å¤–å­˜ä¸€ä»½è»Šç‰Œç´¢å¼•

        const label = path === 'vip_list' ? "ğŸ’ VIPé•·å®˜" : "å“¡å·¥";
        logAction("HQ-ADMIN", `åŒæ­¥${label}: ${name}`);
        alert(`${label} éƒ¨ç½²æˆåŠŸï¼`);
    }

    function upBlack() {
        const name = document.getElementById('eName').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        db.ref('blacklist_data').push({ name, reason: document.getElementById('eDept').value, time: new Date().toLocaleDateString() });
        logAction("HQ-ADMIN", `ğŸ›‘ åˆ—ç®¡é»‘åå–®: ${name}`);
        alert("å·²ç™¼å¸ƒç´…è‰²è­¦æˆ’");
    }

    // æ ¸å¿ƒå¯«å…¥èˆ‡ç›£è½
    function logAction(user, content) {
        db.ref('search_logs').push({ user, query: content, time: new Date().toLocaleString('zh-TW', {hour12: false}) });
    }

    // é¡¯ç¤ºåå–® (é è¦½ç”¨)
    db.ref('employee_list').on('value', s => {
        const l = s.val(), b = document.getElementById('masterList'); b.innerHTML = '';
        for(let k in l) if(k === l[k].id) b.innerHTML += `<tr><td>å“¡å·¥</td><td>${l[k].name}</td><td>${l[k].plate||'--'}</td><td><button class="del-btn" onclick="db.ref('employee_list/${l[k].id}').remove()">åˆªé™¤</button></td></tr>`;
    });

    syncK9Health();
    updateStats();
</script>
</body>
</html>
