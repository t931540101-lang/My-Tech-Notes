<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | HQ æˆ°è¡“æŒ‡æ®ä¸­å¿ƒ V6.0</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #000; color: #00f2ff; font-family: "Microsoft JhengHei", sans-serif; padding: 15px; margin: 0; }
        .header { border-bottom: 2px solid #00f2ff; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .section { background: #111; padding: 15px; border-radius: 5px; border: 1px solid #333; margin-bottom: 20px; position: relative; }
        h2 { color: #4da1ff; font-size: 16px; margin-top: 0; border-left: 5px solid #00f2ff; padding-left: 10px; }
        
        /* çµ±è¨ˆçœ‹æ¿æ¨£å¼ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #1a1a1a; padding: 10px; text-align: center; border-radius: 4px; border: 1px solid #444; }
        .stat-val { font-size: 18px; font-weight: bold; color: #ffca28; }
        .stat-label { font-size: 10px; color: #888; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        input, select { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 10px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn { background: #00f2ff; color: #000; border: none; padding: 12px; font-weight: bold; width: 100%; border-radius: 3px; cursor: pointer; }
        .btn-red { background: #ff4d4f; color: #fff; }
        
        .scroll-box { max-height: 200px; overflow-y: auto; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #4da1ff; border-bottom: 1px solid #333; padding: 8px; font-size: 12px; position: sticky; top: 0; background: #111; }
        td { padding: 10px 8px; border-bottom: 1px solid #222; color: #ccc; }
        
        /* è­¦ç¤ºæ•ˆæœ */
        .alert-row { background: rgba(255, 77, 79, 0.15); border-left: 4px solid #ff4d4f; }
        .k9-warn { color: #ffca28; font-weight: bold; }
        .confirmed { color: #10b981; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 18px;">M-SECURITY HQ</h1>
            <div id="statusInfo" style="color: #888; font-size: 10px;">V6.0 | SYSTEM SECURED</div>
        </div>
        <div id="clock" style="font-family: monospace; font-size: 12px;"></div>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="countLogs">0</div><div class="stat-label">ä»Šæ—¥æŸ¥è©¢</div></div>
        <div class="stat-card"><div class="stat-val" id="countBlack">0</div><div class="stat-label">åˆ—ç®¡åå–®</div></div>
        <div class="stat-card"><div class="stat-val" id="countK9">8</div><div class="stat-label">K9 ç¸½é‡</div></div>
    </div>

    <div class="section" style="border-color: #ffca28;">
        <h2 style="color: #ffca28; border-left-color: #ffca28;">ğŸ” å…¨åŸŸæŸ¥è©¢æ—¥èªŒ (æ””æˆªç›£æ§)</h2>
        <div class="scroll-box">
            <table>
                <thead><tr><th width="20%">æ“ä½œå“¡</th><th width="45%">å°è±¡</th><th width="35%">æ™‚é–“</th></tr></thead>
                <tbody id="searchLogs"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ• K9 è‡¨åºŠç‹€æ…‹èˆ‡é€¾æ™‚æé†’</h2>
        <div class="grid">
            <select id="k9Name">
                <option value="å¸ƒä¸">å¼µå¸ƒä¸</option><option value="å°ç™½">è”¡å°ç™½</option><option value="å°èŠ±">è”¡å°èŠ±</option>
                <option value="ä¾†é †">ä¾†é †</option><option value="ç“œç“œ">å“ˆèœœç“œ</option><option value="è²´è²´">è”¡é ­è²´</option>
                <option value="è”¡å“º">è”¡å“º</option><option value="æœ‰éŒ¢">æœ‰éŒ¢</option>
            </select>
            <input type="text" id="k9Note" placeholder="é†«ç™‚/ç‹€æ³ç´€éŒ„">
        </div>
        <button class="btn" onclick="upK9()">æ›´æ–° K9 ç‹€æ…‹</button>
        <div id="k9Dashboard" style="margin-top: 10px; font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"></div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ äººå“¡ç®¡ç†ä¸­å¿ƒ</h2>
        <div class="grid">
            <input type="text" id="eID" placeholder="å·¥è™Ÿ">
            <input type="text" id="eName" placeholder="å§“å">
        </div>
        <div class="grid">
            <input type="text" id="eDept" placeholder="å–®ä½/é»‘å–®åŸå› ">
            <input type="text" id="ePlate" placeholder="è»Šç‰Œ (é¸å¡«)">
        </div>
        <div class="grid">
            <button class="btn" onclick="upEmp()">åŒæ­¥å“¡å·¥</button>
            <button class="btn btn-red" onclick="upBlack()">åˆ—å…¥é»‘åå–®</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // æ™‚é˜
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

    // --- åŠŸèƒ½ 1: æ•¸æ“šçµ±è¨ˆåˆ†æ ---
    function updateStats() {
        db.ref('search_logs').once('value', s => {
            const logs = s.val() ? Object.values(s.val()).filter(l => l.time.includes(new Date().toLocaleDateString())).length : 0;
            document.getElementById('countLogs').innerText = logs;
        });
        db.ref('blacklist_data').on('value', s => {
            document.getElementById('countBlack').innerText = s.val() ? Object.keys(s.val()).length : 0;
        });
    }

    // --- åŠŸèƒ½ 2: æ—¥èªŒç›£æ§ (å«é»‘åå–®è­¦ç¤º) ---
    let blacklistNames = [];
    db.ref('blacklist_data').on('value', s => {
        const val = s.val();
        blacklistNames = val ? Object.values(val).map(b => b.name) : [];
    });

    db.ref('search_logs').limitToLast(15).on('value', s => {
        const l = s.val(), b = document.getElementById('searchLogs'); b.innerHTML = '';
        if(l) {
            Object.values(l).reverse().forEach(x => {
                const isBlack = blacklistNames.some(name => x.query.includes(name));
                const rowClass = isBlack ? 'class="alert-row"' : '';
                b.innerHTML += `<tr ${rowClass}><td>${x.user}</td><td>${x.query}${isBlack?' ğŸ›‘':''}</td><td>${x.time}</td></tr>`;
            });
        }
        updateStats();
    });

    // --- åŠŸèƒ½ 3: K9 ç‹€æ…‹èˆ‡é€¾æ™‚é‚è¼¯ ---
    const K9_LIST = [{id:'å¸ƒä¸',n:'å¼µå¸ƒä¸'},{id:'å°ç™½',n:'è”¡å°ç™½'},{id:'å°èŠ±',n:'è”¡å°èŠ±'},{id:'ä¾†é †',n:'ä¾†é †'},{id:'ç“œç“œ',n:'å“ˆèœœç“œ'},{id:'è²´è²´',n:'è”¡é ­è²´'},{id:'è”¡å“º',n:'è”¡å“º'},{id:'æœ‰éŒ¢',n:'æœ‰éŒ¢'}];
    
    function syncK9Health() {
        db.ref('k9Logs').on('value', s => {
            const data = s.val(), board = document.getElementById('k9Dashboard');
            board.innerHTML = '';
            K9_LIST.forEach(k => {
                const logs = data && data[k.id] ? Object.values(data[k.id]).sort((a,b)=>b.timestamp-a.timestamp) : [];
                const lastLog = logs[0];
                let timeDiffStr = "å°šç„¡ç´€éŒ„";
                let warnStyle = "";

                if(lastLog) {
                    const diffHours = (Date.now() - lastLog.timestamp) / (1000 * 60 * 60);
                    timeDiffStr = diffHours < 1 ? "å‰›å‰›æ›´æ–°" : Math.floor(diffHours) + " å°æ™‚å‰";
                    if(diffHours > 24) warnStyle = "class='k9-warn'"; 
                }

                board.innerHTML += `<div style="background:#222; padding:8px; border-radius:3px;">
                    <b>${k.n}</b><br>
                    <small ${warnStyle}>â³ ${timeDiffStr}</small>
                </div>`;
            });
        });
    }

    function upK9() {
        const dog = document.getElementById('k9Name').value, note = document.getElementById('k9Note').value;
        if(!note) return alert("ç´€éŒ„ä¸å¯ç©ºç™½");
        db.ref('k9Logs/' + dog).push({ note, timestamp: Date.now(), time: new Date().toLocaleString() });
        logAction("HQ-ADMIN", `K9æ›´æ–°: ${dog} ç‹€æ…‹`);
        document.getElementById('k9Note').value = '';
    }

    // --- æ ¸å¿ƒå¯«å…¥åŠŸèƒ½ ---
    function logAction(user, content) {
        db.ref('search_logs').push({ user, query: content, time: new Date().toLocaleString('zh-TW', {hour12: false}) });
    }

    function upEmp() {
        const id = document.getElementById('eID').value, name = document.getElementById('eName').value;
        if(!id || !name) return alert("å·¥è™Ÿå§“åå¿…å¡«");
        db.ref('employee_list/' + id).set({ id, name, dept: document.getElementById('eDept').value, plate: document.getElementById('ePlate').value });
        logAction("HQ-ADMIN", `åŒæ­¥å“¡å·¥: ${name}`);
        localStorage.setItem('last_up_id', id); // åŸºæœ¬ Local Storage å­˜æª”
    }

    function upBlack() {
        const name = document.getElementById('eName').value, reason = document.getElementById('eDept').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        db.ref('blacklist_data').push({ name, reason, time: new Date().toLocaleDateString() });
        logAction("HQ-ADMIN", `ğŸ›‘ åˆ—ç®¡é»‘åå–®: ${name}`);
        alert("å·²ç™¼å¸ƒç´…è‰²è­¦æˆ’");
    }

    // åˆå§‹åŒ–
    syncK9Health();
    updateStats();
</script>
</body>
</html>
